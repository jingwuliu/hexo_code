---
title: code compile
date: 2021-07-05 14:01:26
tags: [编译]
---

在版本发出前会有编译的步骤，但是对于编译的具体flow没有明确的概念，只知道是将开发源码转换成机器可读的二进制代码的过程，今天我们来具体了解一下。

简单来说，编译器的作用就是将源文件转换为计算机能直接运行的可执行文件，该可执行文件由一条条的执行指令构成。具体来说，编译源文件需要经过 <font color=#FF0000>预处理</font>、<font color=#FF0000>编译</font> 、<font color=#FF0000>汇编</font>、 <font color=#FF0000>链接</font>四个步骤。我们就以hello world程序为例对4步进行介绍。

```
    #include <stdio.h>
    int main(void)
    {
        printf("hello world\n"); //输出hello world
        return 0;
    }

    hello.c文件(源文件)
```

#### 预处理
预处理是从我们编写的源代码到机器可读文件的第一步，上述源码中第一行的"#"号代表这是一条预处理指令，第一行引入了标准输入输出库，我们称之为头文件，或是库。其次预处理的过程帮助我们删除了多余的注释，如第四行的"//输出hello world"。预处理后的文件会将源码开头中引入的库/头文件内容加入到代码中。并删除注释部分，如下图所示。图中可以看到前面的795行都是stdio.h的代码。

![预处理后的文件a](premake1.png)

![预处理后的文件b](premake2.png#pic_center)

#### 编译
编译过程会将预处理后的文件转换为汇编语言表述的文件，汇编语言就是为了简化繁琐的机器语言编程所创造的一系列助记符。汇编语言和机器指令是一一对应的，如果更换cpu，那就要采用对应的汇编语言。
编译阶段首先进行词法分析和语法分析，检查代码的规范性、是否有语法错误等。接下来对代码进行优化，最后生成汇编代码。

![编译后产生的汇编代码](compile.png#pic_center)

#### 汇编
汇编过程就是基于上述与汇编代码对应的机器指令集将汇编代码进行替换的过程，这个过程将汇编代码转换为二进制的目标代码。但目前还不是一个完整的可执行文件，无法运行。还需要最后一步。

![汇编后产生的二进制目标文件](compile1.png)

![16进制显示的二进制目标文件](compile2.png)

#### 链接
经过汇编后生成的二进制目标文件还不是一个完整的可执行文件，仍然缺少库函数，几乎所有的程序中都要使用各类的标准库中的函数，如C语言中的printf()函数，最上面的源码中只包含了对printf()函数的声明，该函数真正的代码(预编译号的二进制文件)存储在其它地方。
除此外，目标文件还缺少启动代码，启动代码充当着程序和操作系统间的接口，不同操作系统所需要的启动代码不同。
所以在链接步骤中，我们需要先将源码中使用到的声明的标准库函数的目标代码，启动代码都合入到汇编产生的二进制目标文件中，生成最终版的二进制可执行文件。

![可执行二进制目标文件](final_file.png)

#### <font color=#FF0000>汇编</font>

![编译流程图](conclude.png)